# フェーズ5-6: レビュー対応計画・厳格責務レビュー

本ドキュメントは、「記事TOC・見出しアンカー周辺モジュール」の責務適合性と今回レビュー指摘に基づくフェーズ修正計画を一元管理するものです。

---

## 1. 概要

本計画は個々の修正が独立しており、段階的コミットが可能です。

### 🔴 高優先度
1. ✅ `autolink` オプションの削除（deprecated）

### 🟡 中優先度
2. ✅ 見出しアンカー履歴操作を push→replace に

### 🟢 低優先度
3. ✅ アクセシビリティ改善（フォーカス可視化）
4. ✅ 依存整理（未使用プラグイン削除）

#### 実施推奨順序
- 1) autolink撤去
- 2) replace化
- 3) A11y強化
- 4) 依存整理

#### 完了条件
- 型チェック: `cd app && npx tsc --noEmit` でエラー0件
- 記事画面の実動作検証
- Lint/フォーマット: 既定ルール遵守
- 各コミットごとにチェンジログ作成

---

## 2. モジュール責務レビュー（詳細）

各対象モジュールについて、「評価」「懸念事項」「改善提案」を統一フォーマットで記載します。

### ✅ 2.1 `app/app/blog/[slug]/page.tsx`（ページコンポーネント）

- **評価**
    - 役割分離（データ取得/表示/境界）は明確。
    - Presentation層への橋渡し責務、TOCや関連取得統合も過不足ない。
- **懸念事項**
    - `EnhancedCodeBlock`への`any`プロップ透過は型安全性上やや懸念。
- **改善提案**
    - ✅ pre受け渡し型を狭める。

### ✅ 2.2 `app/infrastructure/utils/extract-toc.ts`（HTML→TOC抽出, ID付与）

- **評価**
    - 副作用なき関数組成・出力正規化など関数型設計に良い。
- **懸念事項**
    - `RawItem: any`範囲が本来より広い。
- **改善提案**
    - ✅ `RawItem`型定義を狭める。

### ✅ 2.3 `app/infrastructure/utils/html-to-react.ts`（HTML→React＋装飾）

- **評価**
    - 出力純粋性、プレゼン層依存の依存逆転設計は良い。
- **懸念事項**
    - プロップ型が全体的に`any`でランタイム分岐が増。
    - クライアント要素混在設計について注記不足。
- **改善提案**
    - ✅ タグごとの適切な型バインディング強化。
    - ✅ className運用および仕様コメント明示化。

### 2.4 `app/presentation/components/common/toc.tsx`（目次UI）

- **評価**
    - IntersectionObserverやID抽出のパフォーマンス配慮優れている。

### 2.5 `app/presentation/components/common/heading-anchor-button.tsx`（見出しアンカー）

- **評価**
    - クリップボード・履歴・UIフィードバック設計は良好。

### 2.6 `app/package.json`（依存適合性）

- **評価**
    - 必要rehype系依存は網羅